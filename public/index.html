<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡æ‰«ç ç™»å½• - è‡ªåŠ¨ç­¾åˆ°ç³»ç»Ÿ</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 500px;
            width: 100%;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 40px 30px;
            text-align: center;
        }

        .status-section {
            margin-bottom: 30px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .status-valid {
            background: #d4edda;
            color: #155724;
        }

        .status-invalid {
            background: #f8d7da;
            color: #721c24;
        }

        .qr-section {
            display: none;
        }

        .qr-container {
            display: inline-block;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
            position: relative;
        }

        #qrcode {
            width: 256px !important;
            height: 256px !important;
            margin: 0 auto;
        }

        .qr-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 256px;
            height: 256px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px auto;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background: #6c757d;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
        }

        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .token-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
        }

        .token-info h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .token-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .token-info-item:last-child {
            border-bottom: none;
        }

        .hidden {
            display: none !important;
        }

        .checkin-result {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .checkin-result h3 {
            color: #155724;
            margin-bottom: 15px;
        }

        .checkin-result pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
            }

            .content {
                padding: 30px 20px;
            }

            #qrcode {
                width: 200px !important;
                height: 200px !important;
            }

            .qr-loading {
                width: 200px;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ è‡ªåŠ¨ç­¾åˆ°ç³»ç»Ÿ</h1>
            <p>å¾®ä¿¡æ‰«ç ç™»å½•åŠ©æ‰‹</p>
        </div>

        <div class="content">
            <!-- TokençŠ¶æ€æ£€æŸ¥ -->
            <div class="status-section">
                <div id="tokenStatus" class="status-badge">æ£€æŸ¥ä¸­...</div>
                <div id="tokenInfo" class="token-info hidden">
                    <h3>Token çŠ¶æ€</h3>
                    <div class="token-info-item">
                        <span>TokençŠ¶æ€:</span>
                        <span id="tokenValid">-</span>
                    </div>
                    <div class="token-info-item">
                        <span>è¿‡æœŸæ—¶é—´:</span>
                        <span id="tokenExpire">-</span>
                    </div>
                    <div class="token-info-item">
                        <span>å‰©ä½™æ—¶é—´:</span>
                        <span id="tokenRemaining">-</span>
                    </div>
                </div>
            </div>

            <!-- è°ƒåº¦å™¨çŠ¶æ€ -->
            <div class="status-section">
                <div id="schedulerStatus" class="status-badge">æ£€æŸ¥ä¸­...</div>
                <div id="schedulerInfo" class="token-info hidden">
                    <h3>ğŸ• å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨</h3>
                    <div class="token-info-item">
                        <span>è°ƒåº¦å™¨çŠ¶æ€:</span>
                        <span id="schedulerRunning">-</span>
                    </div>
                    <div class="token-info-item">
                        <span>æ¯æ—¥ç­¾åˆ°:</span>
                        <span id="checkinJobStatus">-</span>
                    </div>
                    <div class="token-info-item">
                        <span>ä¸‹æ¬¡ç­¾åˆ°:</span>
                        <span id="nextCheckinTime">-</span>
                    </div>
                </div>
            </div>

            <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="messageArea"></div>

            <!-- äºŒç»´ç æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="qrSection" class="qr-section">
                <h3>è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç </h3>
                <div class="qr-loading" id="qrLoading">
                    <div class="spinner"></div>
                </div>
                <div class="qr-container" id="qrContainer" style="display: none;">
                    <canvas id="qrcode"></canvas>
                </div>
                <p style="color: #666; font-size: 14px; margin-top: 15px;">
                    äºŒç»´ç æœ‰æ•ˆæœŸä¸º5åˆ†é’Ÿï¼Œè¿‡æœŸåè¯·é‡æ–°ç”Ÿæˆ
                </p>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="actions">
                <button id="generateQR" class="button" onclick="generateQRCode()">
                    ğŸ“± ç”ŸæˆäºŒç»´ç 
                </button>
                <button id="checkinBtn" class="button" onclick="manualCheckin()">
                    âœ… æ‰‹åŠ¨ç­¾åˆ°
                </button>
                <button id="sendEmailBtn" class="button button-secondary" onclick="sendReauthEmail()">
                    ğŸ“§ å‘é€é‡æ–°æˆæƒé‚®ä»¶
                </button>
                <button id="refreshBtn" class="button button-secondary" onclick="refreshStatus()">
                    ğŸ”„ åˆ·æ–°çŠ¶æ€
                </button>
            </div>

            <!-- è°ƒåº¦å™¨ç®¡ç†æŒ‰é’® -->
            <div class="actions" style="margin-top: 15px;">
                <button id="triggerCheckinBtn" class="button button-secondary" onclick="triggerScheduledCheckin()">
                    ğŸ• è§¦å‘å®šæ—¶ç­¾åˆ°
                </button>
                <button id="startSchedulerBtn" class="button button-secondary" onclick="startScheduler()">
                    â–¶ï¸ å¯åŠ¨è°ƒåº¦å™¨
                </button>
                <button id="stopSchedulerBtn" class="button button-secondary" onclick="stopScheduler()">
                    â¸ï¸ åœæ­¢è°ƒåº¦å™¨
                </button>
            </div>

            <!-- ç­¾åˆ°ç»“æœæ˜¾ç¤º -->
            <div id="checkinResult" class="checkin-result hidden">
                <h3>âœ… ç­¾åˆ°ç»“æœ</h3>
                <pre id="checkinResultContent"></pre>
            </div>
        </div>
    </div>

    <script>
        let socket;
        let currentSessionId = null;

        // åˆå§‹åŒ–Socket.IOè¿æ¥
        function initSocket() {
            socket = io();

            socket.on('connect', () => {
                console.log('Connected to server');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                showMessage('ä¸æœåŠ¡å™¨çš„è¿æ¥å·²æ–­å¼€', 'warning');
            });

            socket.onAny((eventName, data) => {
                console.log('Received event:', eventName, data);
                handleSocketEvent(eventName, data);
            });
        }

        // å¤„ç†Socket.IOäº‹ä»¶
        function handleSocketEvent(eventName, data) {
            if (eventName === currentSessionId) {
                switch (data.type) {
                    case 'scanned':
                        showMessage('å·²æ‰«ç ï¼Œæ­£åœ¨è·å–token...', 'success');
                        hideQRCode();
                        break;
                    case 'success':
                        showMessage('ç™»å½•æˆåŠŸï¼æ­£åœ¨è‡ªåŠ¨ç­¾åˆ°...', 'success');
                        refreshTokenStatus();
                        break;
                    case 'checkin_complete':
                        showCheckinResult(data.result);
                        showMessage('è‡ªåŠ¨ç­¾åˆ°å®Œæˆï¼', 'success');
                        break;
                    case 'checkin_error':
                        showMessage(`è‡ªåŠ¨ç­¾åˆ°å¤±è´¥: ${data.error}`, 'error');
                        break;
                    case 'error':
                        showMessage(data.message || 'æ“ä½œå¤±è´¥', 'error');
                        resetQRSection();
                        break;
                    case 'expired':
                        showMessage('äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç”Ÿæˆ', 'warning');
                        resetQRSection();
                        break;
                }
            }
        }

        // æ£€æŸ¥TokençŠ¶æ€
        async function checkTokenStatus() {
            try {
                const response = await fetch('/api/token-status');
                const data = await response.json();
                updateTokenStatus(data);
            } catch (error) {
                console.error('Failed to check token status:', error);
                showMessage('æ£€æŸ¥TokençŠ¶æ€å¤±è´¥', 'error');
            }
        }

        // æ£€æŸ¥è°ƒåº¦å™¨çŠ¶æ€
        async function checkSchedulerStatus() {
            try {
                const response = await fetch('/api/scheduler-status');
                const data = await response.json();
                updateSchedulerStatus(data);
            } catch (error) {
                console.error('Failed to check scheduler status:', error);
                showMessage('æ£€æŸ¥è°ƒåº¦å™¨çŠ¶æ€å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°TokençŠ¶æ€æ˜¾ç¤º
        function updateTokenStatus(data) {
            const statusBadge = document.getElementById('tokenStatus');
            const tokenInfo = document.getElementById('tokenInfo');

            if (data.hasToken && data.isValid) {
                statusBadge.textContent = 'âœ… Tokenæœ‰æ•ˆ';
                statusBadge.className = 'status-badge status-valid';

                tokenInfo.classList.remove('hidden');
                document.getElementById('tokenValid').textContent = 'æœ‰æ•ˆ';
                document.getElementById('tokenExpire').textContent = data.expire ? new Date(data.expire).toLocaleString() : '-';

                const remaining = data.timeUntilExpiry;
                if (remaining !== null) {
                    const hours = Math.floor(remaining / (1000 * 60 * 60));
                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    document.getElementById('tokenRemaining').textContent = `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;

                    if (data.willExpireWithin1Hour) {
                        statusBadge.textContent = 'âš ï¸ Tokenå³å°†è¿‡æœŸ';
                        statusBadge.className = 'status-badge status-invalid';
                    }
                } else {
                    document.getElementById('tokenRemaining').textContent = '-';
                }

                document.getElementById('generateQR').disabled = true;
                document.getElementById('checkinBtn').disabled = false;

            } else {
                statusBadge.textContent = 'âŒ Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ';
                statusBadge.className = 'status-badge status-invalid';

                tokenInfo.classList.add('hidden');
                document.getElementById('generateQR').disabled = false;
                document.getElementById('checkinBtn').disabled = true;
            }
        }

        // æ›´æ–°è°ƒåº¦å™¨çŠ¶æ€æ˜¾ç¤º
        function updateSchedulerStatus(data) {
            const statusBadge = document.getElementById('schedulerStatus');
            const schedulerInfo = document.getElementById('schedulerInfo');

            if (data.isRunning) {
                statusBadge.textContent = 'âœ… è°ƒåº¦å™¨è¿è¡Œä¸­';
                statusBadge.className = 'status-badge status-valid';
            } else {
                statusBadge.textContent = 'â¸ï¸ è°ƒåº¦å™¨å·²åœæ­¢';
                statusBadge.className = 'status-badge status-invalid';
            }

            schedulerInfo.classList.remove('hidden');
            document.getElementById('schedulerRunning').textContent = data.isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
            document.getElementById('checkinJobStatus').textContent = data.checkinJobStatus ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';

            document.getElementById('nextCheckinTime').textContent = data.nextCheckinDate ?
                new Date(data.nextCheckinDate).toLocaleString() : '-';

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('startSchedulerBtn').disabled = data.isRunning;
            document.getElementById('stopSchedulerBtn').disabled = !data.isRunning;
        }

        // ç”ŸæˆäºŒç»´ç 
        async function generateQRCode() {
            try {
                showMessage('æ­£åœ¨ç”ŸæˆäºŒç»´ç ...', 'success');
                showQRLoading();

                const response = await fetch('/api/qrcode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (response.ok) {
                    currentSessionId = data.sessionId;
                    await displayQRCode(data.qrUrl);
                    showMessage('è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç ', 'success');
                } else {
                    throw new Error(data.error || 'ç”ŸæˆäºŒç»´ç å¤±è´¥');
                }

            } catch (error) {
                console.error('Failed to generate QR code:', error);
                showMessage(`ç”ŸæˆäºŒç»´ç å¤±è´¥: ${error.message}`, 'error');
                resetQRSection();
            }
        }

        // æ˜¾ç¤ºäºŒç»´ç 
        async function displayQRCode(qrUrl) {
            hideQRLoading();
            const qrContainer = document.getElementById('qrContainer');
            const qrcodeCanvas = document.getElementById('qrcode');

            try {
                // ç›´æ¥æ˜¾ç¤ºå¾®ä¿¡äºŒç»´ç å›¾ç‰‡ï¼Œè€Œä¸æ˜¯ç”Ÿæˆæ–°çš„äºŒç»´ç 
                qrcodeCanvas.style.display = 'none';

                // åˆ›å»ºimgå…ƒç´ æ¥æ˜¾ç¤ºå¾®ä¿¡äºŒç»´ç 
                let qrImage = document.getElementById('qrImage');
                if (!qrImage) {
                    qrImage = document.createElement('img');
                    qrImage.id = 'qrImage';
                    qrImage.style.width = '256px';
                    qrImage.style.height = '256px';
                    qrContainer.appendChild(qrImage);
                }

                qrImage.src = qrUrl;
                qrContainer.style.display = 'block';
                document.getElementById('qrSection').style.display = 'block';

            } catch (error) {
                console.error('Failed to display QR code image:', error);
                showMessage('æ˜¾ç¤ºäºŒç»´ç å›¾ç‰‡å¤±è´¥', 'error');
                resetQRSection();
            }
        }

        // æ‰‹åŠ¨ç­¾åˆ°
        async function manualCheckin() {
            try {
                document.getElementById('checkinBtn').disabled = true;
                showMessage('æ­£åœ¨æ‰§è¡Œç­¾åˆ°...', 'success');

                const response = await fetch('/api/checkin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showCheckinResult(data.result);
                    showMessage('ç­¾åˆ°å®Œæˆï¼', 'success');
                } else {
                    if (data.needReauth) {
                        showMessage('Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°æ‰«ç æˆæƒ', 'warning');
                        generateQRCode();
                    } else {
                        throw new Error(data.error || 'ç­¾åˆ°å¤±è´¥');
                    }
                }

            } catch (error) {
                console.error('Check-in failed:', error);
                showMessage(`ç­¾åˆ°å¤±è´¥: ${error.message}`, 'error');
            } finally {
                document.getElementById('checkinBtn').disabled = false;
            }
        }

        // å‘é€é‡æ–°æˆæƒé‚®ä»¶
        async function sendReauthEmail() {
            try {
                document.getElementById('sendEmailBtn').disabled = true;
                showMessage('æ­£åœ¨å‘é€é‚®ä»¶...', 'success');

                const response = await fetch('/api/send-reauth-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('é‡æ–°æˆæƒé‚®ä»¶å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶', 'success');
                } else {
                    throw new Error(data.error || 'å‘é€é‚®ä»¶å¤±è´¥');
                }

            } catch (error) {
                console.error('Failed to send email:', error);
                showMessage(`å‘é€é‚®ä»¶å¤±è´¥: ${error.message}`, 'error');
            } finally {
                document.getElementById('sendEmailBtn').disabled = false;
            }
        }

        // åˆ·æ–°çŠ¶æ€
        async function refreshStatus() {
            document.getElementById('refreshBtn').disabled = true;
            await Promise.all([
                checkTokenStatus(),
                checkSchedulerStatus()
            ]);
            document.getElementById('refreshBtn').disabled = false;
        }

        // è§¦å‘å®šæ—¶ç­¾åˆ°
        async function triggerScheduledCheckin() {
            try {
                document.getElementById('triggerCheckinBtn').disabled = true;
                showMessage('æ­£åœ¨è§¦å‘å®šæ—¶ç­¾åˆ°...', 'success');

                const response = await fetch('/api/trigger-checkin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(data.message || 'å®šæ—¶ç­¾åˆ°å·²è§¦å‘', 'success');
                } else {
                    throw new Error(data.error || 'è§¦å‘å®šæ—¶ç­¾åˆ°å¤±è´¥');
                }

            } catch (error) {
                console.error('Failed to trigger scheduled check-in:', error);
                showMessage(`è§¦å‘å®šæ—¶ç­¾åˆ°å¤±è´¥: ${error.message}`, 'error');
            } finally {
                document.getElementById('triggerCheckinBtn').disabled = false;
            }
        }

      
        // å¯åŠ¨è°ƒåº¦å™¨
        async function startScheduler() {
            try {
                document.getElementById('startSchedulerBtn').disabled = true;
                showMessage('æ­£åœ¨å¯åŠ¨è°ƒåº¦å™¨...', 'success');

                const response = await fetch('/api/start-scheduler', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(data.message || 'è°ƒåº¦å™¨å·²å¯åŠ¨', 'success');
                    await checkSchedulerStatus();
                } else {
                    throw new Error(data.error || 'å¯åŠ¨è°ƒåº¦å™¨å¤±è´¥');
                }

            } catch (error) {
                console.error('Failed to start scheduler:', error);
                showMessage(`å¯åŠ¨è°ƒåº¦å™¨å¤±è´¥: ${error.message}`, 'error');
            } finally {
                document.getElementById('startSchedulerBtn').disabled = false;
            }
        }

        // åœæ­¢è°ƒåº¦å™¨
        async function stopScheduler() {
            try {
                document.getElementById('stopSchedulerBtn').disabled = true;
                showMessage('æ­£åœ¨åœæ­¢è°ƒåº¦å™¨...', 'success');

                const response = await fetch('/api/stop-scheduler', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage(data.message || 'è°ƒåº¦å™¨å·²åœæ­¢', 'success');
                    await checkSchedulerStatus();
                } else {
                    throw new Error(data.error || 'åœæ­¢è°ƒåº¦å™¨å¤±è´¥');
                }

            } catch (error) {
                console.error('Failed to stop scheduler:', error);
                showMessage(`åœæ­¢è°ƒåº¦å™¨å¤±è´¥: ${error.message}`, 'error');
            } finally {
                document.getElementById('stopSchedulerBtn').disabled = false;
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'success') {
            const messageArea = document.getElementById('messageArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;

            messageArea.innerHTML = '';
            messageArea.appendChild(messageDiv);

            // 5ç§’åè‡ªåŠ¨éšè—æ¶ˆæ¯
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        // æ˜¾ç¤ºç­¾åˆ°ç»“æœ
        function showCheckinResult(result) {
            const checkinResult = document.getElementById('checkinResult');
            const checkinResultContent = document.getElementById('checkinResultContent');

            checkinResultContent.textContent = JSON.stringify(result, null, 2);
            checkinResult.classList.remove('hidden');
        }

        // æ˜¾ç¤ºäºŒç»´ç åŠ è½½çŠ¶æ€
        function showQRLoading() {
            document.getElementById('qrLoading').style.display = 'flex';
            document.getElementById('qrContainer').style.display = 'none';
            document.getElementById('qrSection').style.display = 'block';
        }

        // éšè—äºŒç»´ç åŠ è½½çŠ¶æ€
        function hideQRLoading() {
            document.getElementById('qrLoading').style.display = 'none';
            // ç¡®ä¿canvasé»˜è®¤å¯è§
            const qrcodeCanvas = document.getElementById('qrcode');
            if (qrcodeCanvas && qrcodeCanvas.style.display === 'none') {
                qrcodeCanvas.style.display = 'block';
            }
        }

        // éšè—äºŒç»´ç 
        function hideQRCode() {
            document.getElementById('qrSection').style.display = 'none';
        }

        // é‡ç½®äºŒç»´ç åŒºåŸŸ
        function resetQRSection() {
            hideQRCode();
            hideQRLoading();

            // æ¸…ç†åˆ›å»ºçš„å›¾ç‰‡å…ƒç´ 
            const qrImage = document.getElementById('qrImage');
            if (qrImage) {
                qrImage.remove();
            }

            // æ¢å¤canvasæ˜¾ç¤º
            const qrcodeCanvas = document.getElementById('qrcode');
            if (qrcodeCanvas) {
                qrcodeCanvas.style.display = 'block';
            }

            currentSessionId = null;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
            Promise.all([
                checkTokenStatus(),
                checkSchedulerStatus()
            ]);

            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
            setInterval(() => {
                Promise.all([
                    checkTokenStatus(),
                    checkSchedulerStatus()
                ]);
            }, 30000);
        });
    </script>
</body>
</html>